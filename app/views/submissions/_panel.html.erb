<% random_id = SecureRandom.random_number(10000000) %>
<h3><%= submission.title %></h3>
<p class="card-text">
  <strong>Submission-Date: </strong><%= submission.created_at.strftime("%d/%m/%Y") %>
</p>
<p class="card-text">
  <strong>Status: </strong><%= submission.status %>
</p>
<p>
  <% if submission.file.attached? %>
    <% if submission.file.previewable? %>
      <%= link_to(image_tag(submission.file.preview(resize: "200x200>")),  rails_blob_path(submission.file, disposition: "attachment"))
      %>
    <% elsif submission.file.variable? %>
      <%= link_to(image_tag(submission.file.variant(resize: "200x200")), rails_blob_path(submission.file, disposition: "attachment"))%>
    <% else %>
      <%= link_to "Download", rails_blob_path(submission.file, disposition: "attachment"), class: "text-white" %>
    <% end %>
  <% end %>
</p>
<hr />
<ul class="nav nav-pills mb-3" id="pills-tab-submission-<%= submission.id %>-random-id-<%= random_id %>" role="tablist">
  <li class="nav-item" role="presentation">
    <a class="nav-link active" id="pills-action-tab" data-toggle="pill" href="#pills-action-<%= submission.id %>-random-id-<%= random_id %>" role="tab" aria-controls="pills-action" aria-selected="true">Action</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link" id="pills-history-tab" data-toggle="pill" href="#pills-history-<%= submission.id %>-random-id-<%= random_id %>" role="tab" aria-controls="pills-history" aria-selected="false">History</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link" id="pills-report-tab" data-toggle="pill" href="#pills-report-<%= submission.id %>-random-id-<%= random_id %>" role="tab" aria-controls="pills-report" aria-selected="false">Report</a>
  </li>
</ul>
<hr />
<div class="tab-content" id="pills-tab-submission-<%= submission.id %>-content">
  <div class="tab-pane fade show active" id="pills-action-<%= submission.id %>-random-id-<%= random_id %>" role="tabpanel" aria-labelledby="pills-action-tab">
    <% if current_user.nil? %>
    <p>
        <strong>  <%= link_to('Please log in', new_user_session_path) %></strong>
    </p>
    <% end %>
    <% unless current_user.nil? %>
      <%= form_tag submissions_create_suggestion_to_user_path do %>
        <%#= file_field_tag :file, class: "btn btn-secondary" %>
        <%= select_tag :user_id, options_for_select(User.all.collect{ |u| [u.name, u.id] }) %>
        <%= hidden_field_tag :submission_id, submission.id %>
        <br />
        <br />
        <%#= submit_tag "Submit", class: "btn btn-primary", id: "actual_bibtex_enter_button" %>
        <%= button_tag "Send Suggestion", class: "btn btn-success btn-block", id: "actual_bibtex_enter_button" %>
      <% end %>
      <br />
    <%= mail_to "", "Suggest per mail", subject: "Review for Dialectica", body: "Dear Reviewer \n\n There is a new submission on Dialectica called \"#{submission.title}\". \n\n Please take a look, it is in your area of expertise! \n\n View it here: #{submission_url(submission)} \n\n Kind regards \n\n #{current_user.name unless current_user.blank?}", class: "btn btn-success btn-block my-2" %>
    <%#= link_to "Suggest to another user", submissions_create_suggestion_to_user_path(current_user.id, submission.id), method: :post, class: "btn btn-success btn-block my-2" %>

    <% if is_user_reviewer?(current_user) %>
      <hr />
      <%  if current_user.submissions.where(id: submission.id).empty?  %>
        <%= link_to "Sign up as Internal Referee", submissions_add_user_to_submission_path(current_user.id, submission.id), method: :post, class: "btn btn-primary btn-block my-2" %>
        <%#= link_to "I know someone who could review it", submissions_add_user_to_submission_path(current_user.id, submission.id), method: :post, class: "btn btn-success my-2" %>
      <% else %>
        <%= link_to "Add Report", new_report_for_reviewer_path(submission.id), class: "btn btn-info btn-block my-2" %>
        <% if submission.proposed == "false" %>
          <%= link_to "Propose for publication", propose_submission_path(submission.id, submission.id), method: :post, class: "btn btn-primary btn-block my-2" %>
        <% else %>
          <%= link_to "Withdraw proposal of publication", withdraw_proposal_of_submission_path(submission.id, submission.id), method: :post, class: "btn btn-primary btn-block my-2" %>
        <% end %>

        <%= link_to "Quit as Internal Referee", submissions_remove_user_from_submission_path(current_user.id, submission.id), method: :post, class: "btn btn-danger btn-block my-2" %>
      <% end %>
    <% end %>


      <% if is_user_editor?(current_user) %>
        <hr />
        <%= link_to "Accept", submissions_add_user_to_submission_path(current_user.id, submission.id), method: :post, class: "btn btn-success btn-block my-2" %>
        <%= link_to "Reject", submissions_add_user_to_submission_path(current_user.id, submission.id), method: :post, class: "btn btn-danger btn-block my-2" %>
      <% end %>
    <%#= link_to "I know someone who could review it", submissions_add_user_to_submission_path(current_user.id, submission.id), method: :post, class: "btn btn-success btn-block my-2" %>
    <% end %>
  </div>
  <div class="tab-pane fade" id="pills-history-<%= submission.id %>-random-id-<%= random_id %>" role="tabpanel" aria-labelledby="pills-history-tab">
    <p class="card-text">
      <strong>History: </strong>
    </p>
    <div class="border rounded p-2">
      <%= raw Sanitize.fragment(submission.history, Sanitize::Config::RELAXED) %>
    </div>
  </div>
  <div class="tab-pane fade" id="pills-report-<%= submission.id %>-random-id-<%= random_id %>" role="tabpanel" aria-labelledby="pills-reportR-tab">
    <p class="card-text">
      <strong>Reports: </strong>
    </p>
      <% submission.reports.each do |report| %>
        <%= render "reports/show", report: report %>
      <% end %>
  </div>
</div>
